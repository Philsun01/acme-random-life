<html>
  <head>
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/react-router-dom/5.0.1/react-router-dom.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/Faker/3.1.0/faker.js'></script>
<style>
body {
  font-family: verdana;
}
nav {
  display: flex;
  justify-content: space-around;
}

.selected {
  background-color: tomato;
  color: white;
  padding: 0.5rem;
  border-radius: 0.25rem;
}

input, button {
  height: 2rem;
  font-size: 1rem;
}
</style>
  </head>
  <body>
    <div id='root'></div>
    <script type='text/babel'>

      const API = 'https://acme-users-api-rev.herokuapp.com/api';

      const fetchUser = async ()=> {
        const storage = window.localStorage;
        const userId = storage.getItem('userId');
        if(userId){
          try {
            return (await axios.get(`${API}/users/detail/${userId}`)).data;
          }
          catch(ex){
            storage.removeItem('userId');
            return fetchUser();
          }
        }
        const user = (await axios.get(`${API}/users/random`)).data;
        storage.setItem('userId', user.id);
        return  user;
      };

      const { render } = ReactDOM;
      const { Component } = React;
      const { HashRouter, Route, Link, Switch, Redirect } = ReactRouterDOM;



      const renderNotes = (notes, destroy)=> {
        console.log(notes);
        return(
          <ul>
            {
              notes.map((note,idx)=>{
              return(
                <div key = {idx}>
                <li>{note.text}</li>
                <button onClick = {()=>destroy(note)}>Destroy</button>
                </div>)
                })
              }
          </ul>
        )
      }

      class App extends Component {
        constructor(){
          super();
          this.state = {
            user:'',
            userId:'',
            notes:[]
          }
          this.addNote = this.addNote.bind(this);
          this.destroy = this.destroy.bind(this);
        }

        async componentDidMount(){
          const user = await fetchUser();
          const userId = user.id;
          //console.log(user);
          const notes = (await axios.get(`${API}/users/${userId}/notes`)).data;

          this.setState({user, userId, notes});
        }

        async addNote(notes){
          const {userId} = window.localStorage;

          const randomPhrase = `${faker.commerce.productAdjective()} ${faker.finance.accountName()} with ${faker.commerce.product()}`;

          const posting = (await axios.post(`${API}/users/${userId}/notes`,{archived: false,text: randomPhrase})).data;

        this.setState({notes: [...notes,posting]});
        }

        async destroy(note){
          await axios.delete(`${API}/users/${this.state.user.id}/notes/${note.id}`);
          this.setState({ notes : this.state.notes.filter( _note => _note.id !== note.id)});
        }

        render(){
          const {user, userId, notes} = this.state;
          const {destroy} = this;
          console.log(user);
          return (
            <div>
              <h1>Hello {user.fullName}</h1>
              <h3>Your Id is {userId}</h3>
              <hr/>
              <h2> Notes Section </h2>
              <button onClick = { ()=>this.addNote(notes) } disabled = {notes.length>4}> Generate Notes </button>
              {renderNotes(notes,destroy)}
              <hr/>

            </div>
          )
        }
      }

      const root = document.querySelector('#root');
      render(<App />, root);
    </script>
  </body>
</html>
